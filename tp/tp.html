<html>
    <head>
        <title>Sistemas Gr&aacute;ficos - Trabajo Pr&aacute;ctico</title>
        <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

        <script type="text/javascript" src="./utils/gl-matrix-2.2.0.js"></script>
        <script type="text/javascript" src="./utils/webgl-utils.js"></script>
        <script type="text/javascript" src="./utils/vectorUtils.js"></script>
        <script type="text/javascript" src="./utils/Program.js"></script>

        <script type="text/javascript" src="./shapes/curves/BezierCuadCurve.js"></script>
        <script type="text/javascript" src="./shapes/curves/BSplineCuadCurve.js"></script>

        <script type="text/javascript" src="./shapes/surfaces/SupBarr.js"></script>
        <script type="text/javascript" src="./shapes/surfaces/island.js"></script>
        <script type="text/javascript" src="./shapes/surfaces/ship.js"></script>
        <script type="text/javascript" src="./shapes/surfaces/commandBridge.js"></script>

        <script type="text/javascript" src="./cameras/CameraManager.js"></script>
        <script type="text/javascript" src="./cameras/FreeCamera.js"></script>
        <script type="text/javascript" src="./cameras/WalkingCamera.js"></script>
        <script type="text/javascript" src="./cameras/FirstPersonCamera.js"></script>
        <script type="text/javascript" src="./cameras/OrbitalCamera.js"></script>

        <script type="text/javascript" src="./shapes/ShapeGroup.js"></script>
        <script type="text/javascript" src="./shapes/Shape.js"></script>
        <script type="text/javascript" src="./shapes/Background.js"></script>
        <script type="text/javascript" src="./shapes/TexturedSphere.js"></script>
        <script type="text/javascript" src="./shapes/plane.js"></script>
        <script type="text/javascript" src="./shapes/fan.js"></script>
        <script type="text/javascript" src="./shapes/cylinder.js"></script>
        <script type="text/javascript" src="./shapes/box.js"></script>
        <script type="text/javascript" src="./shapes/Pharo.js"></script>
        <script type="text/javascript" src="./shapes/Pharos.js"></script>

        <script type="text/javascript" src="./shapes/crane/Frame.js"></script>
        <script type="text/javascript" src="./shapes/crane/MovingThing.js"></script>
        <script type="text/javascript" src="./shapes/crane/Crane.js"></script>
        <script type="text/javascript" src="./shapes/crane/CargoMover.js"></script>
        <script type="text/javascript" src="./shapes/crane/planeWindow.js"></script>
        <script type="text/javascript" src="./shapes/crane/Cabin.js"></script>
        <script type="text/javascript" src="./shapes/crane/Cargo.js"></script>

        <script id="shader-fs-difuso" type="x-shader/x-fragment">
            precision mediump float;

            struct Material {
                vec3 Ka;
                vec3 Kd;
                vec3 Ks;
                float Shininess;
            };

            uniform Material material;

            uniform vec3 uCameraPosition;

            uniform vec3 uLightColor;
            uniform vec3 lights[3];            

            varying vec2 vTextureCoord;
            varying vec3 vVertex;
            varying vec3 vNormal;

            uniform sampler2D uSampler;

            vec3 ads(void) {

                vec3 N = normalize(vNormal);
                vec3 finalColor = vec3(0.0, 0.0, 0.0);

                for (int i = 0; i < 3; i++) {
                    vec3 L = normalize(lights[i] - vVertex);
                    vec3 V = normalize(uCameraPosition - vVertex);
                    vec3 R = normalize(reflect(-L,N));

                    vec3 Rd = material.Kd * max(dot(N,L), 0.0);
                    vec3 Rs = material.Ks * pow(max(dot(R,V), 0.0), material.Shininess);

                    finalColor += uLightColor * clamp(material.Ka + Rd + Rs, 0.0, 1.0);
                }

                return finalColor;
            }

            void main(void) {
                vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
                gl_FragColor = vec4(normalize(vNormal), 1.0);
                //gl_FragColor = vec4(textureColor.rgb * ads(), textureColor.a);
            }

        </script>

        <script id="shader-fs-reflexion" type="x-shader/x-fragment">
            precision mediump float;

            struct Material {
                vec3 Ka;
                vec3 Kd;
                vec3 Ks;
                float Shininess;
            };

            uniform Material material;

            uniform vec3 uCameraPosition;

            uniform vec3 uLightColor;
            uniform vec3 lights[3];            

            varying vec2 vTextureCoord;
            varying vec3 vVertex;
            varying vec3 vNormal;

            uniform sampler2D uSampler;
            uniform sampler2D uReflTexture;
            uniform bool uActiveReflexion;

            const float PI = 3.14159265358979323846264;

            vec3 ads(void) {

                vec3 N = normalize(vNormal);
                vec3 finalColor = vec3(0.0, 0.0, 0.0);

                for (int i = 0; i < 3; i++) {
                    vec3 L = normalize(lights[i] - vVertex);
                    vec3 V = normalize(uCameraPosition - vVertex);
                    vec3 R = normalize(reflect(-L,N));

                    vec3 Rd = material.Kd * max(dot(N,L), 0.0);
                    vec3 Rs = material.Ks * pow(max(dot(R,V), 0.0), material.Shininess);

                    finalColor += uLightColor * (material.Ka + Rd + Rs);
                }

                return finalColor;
            }

            vec3 reflex(void) {

                vec3 N = normalize(vNormal);
                vec4 finalColor = vec4(0.0, 0.0, 0.0, 0.0);

                vec3 V = normalize(uCameraPosition - vVertex);
                vec3 R = normalize(reflect(V,N));

                vec2 textCoorRef = vec2(0.0, 0.0);
                textCoorRef.s = (0.5 + ((1.0/(2.0*PI))*atan(N.z, N.x)));
                textCoorRef.t = (0.5 - ((1.0/PI)*asin(N.y)));

                finalColor = texture2D(uReflTexture, vec2(textCoorRef.s, textCoorRef.t));

                //return (uLightColor * finalColor.rgb);
                return finalColor.rgb;
            }

            void main(void) {
                vec4 textureColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
                if (uActiveReflexion) {
                    gl_FragColor = vec4(textureColor.rgb * (ads() + 0.7 * reflex()), textureColor.a);
                    //gl_FragColor = vec4(textureColor.rgb * (0.7 * reflex()), textureColor.a);
                }
                else {
                    //gl_FragColor = vec4(normalize(vNormal) / 2.0 + 0.5, 1.0);
                    gl_FragColor = vec4(textureColor.rgb * ads(), textureColor.a);
                }
                //gl_FragColor = vec4(textureColor.rgb * ads(), textureColor.a);
                gl_FragColor = vec4(normalize(vNormal) / 2.0 + 0.5, 1.0);
            }

        </script>

        <script id="shader-vs" type="x-shader/x-vertex">
            attribute vec3 aVertexPosition;
            attribute vec3 aVertexNormal;
            attribute vec2 aTextureCoord;

            uniform mat4 uModelMatrix;
            uniform mat4 uViewMatrix;
            uniform mat4 uPMatrix;
            uniform mat3 uNMatrix;

            uniform float utick;
            uniform bool isWater;

            varying vec2 vTextureCoord;
            varying vec3 vVertex;
            varying vec3 vNormal;

            void main(void) {
                vec3 aux_pos = aVertexPosition;

                //Verifico si es water, para "moverlo"
                if (isWater) {
                    aux_pos.z = aux_pos.z + cos( 3.14/150.0 * aux_pos.x + 2.0*utick) * cos(3.14/150.0 * aux_pos.y + 1.0*utick);
                }

                // Transformamos al vertice al espacio de modelo
                vec4 aux_vertex = uModelMatrix * vec4(aux_pos, 1.0);

                // Transformamos al vertice al espacio de la proyeccion
                gl_Position = uPMatrix * uViewMatrix * aux_vertex;

                vVertex = vec3(aux_vertex);
                vNormal = normalize(uNMatrix * aVertexNormal);

                // Coordenada de textura sin modificaciones
                vTextureCoord = aTextureCoord;
            }

        </script>


        <script type="text/javascript">

            var gl;

            function initGL(canvas) {
                try {
                    gl = canvas.getContext("experimental-webgl");
                    gl.viewportWidth = canvas.width;
                    gl.viewportHeight = canvas.height;
                } catch (e) {
                }
                if (!gl) {
                    alert("Could not initialise WebGL, sorry :-(");
                }
            }

            var shaderProgram;
            var program;
            
            
            function initShaders() {
                /*program = new Program(gl, "shader-vs", "shader-fs-difuso");
                program.initShaders();
                program.definitionVariablesDifuso();
                shaderProgram = program.getProgram();*/

                program = new Program(gl, "shader-vs", "shader-fs-reflexion");
                program.initShaders();
                program.definitionVariablesReflexion();
                shaderProgram = program.getProgram();

            }

            var pMatrix = null;

            var currentlyPressedKeys = {};

            var all = null;
            var bckShape = null;
            var floorShape = null;

            var bck = null;
            var floor = null;
            var crane = null;
            var ship = null;
            var island = null;

            var water = null;
            var waterShape = null;
            var shader_utick = 0.0;

            var cameras = null;
            var locked = false;

            var pharos = null;
            var pharosShape = null;
            var lightCabin = null;
            var lightCabinShape = null;

            var pitch = 0;
            var yaw = 0;
            var rotAmount = 0.005;

            var lightColor = [0.7, 0.7, 0.7];
            var lightPosition0 = [11.9, 2.2, 14.8];
            var lightPosition1 = [0.0, -0.3, 24.5];
            var lightPosition2 = [0.0, -0.3, 4.0];

            var textureReflexion = null;

            function objectUniform(){
                //gl.uniform3f(shaderProgram.ambientColorUniform, 0.1, 0.1, 0.1 );
                //gl.uniform3f(shaderProgram.directionalColorUniform, 0.4, 0.4, 0.2);
            }	

            function initTextureReflexion(texture_file) {

                var aux_texture = gl.createTexture();
                textureReflexion = aux_texture;
                textureReflexion.image = new Image();

                var texture = textureReflexion;
                var image = textureReflexion.image;

                textureReflexion.image.onload = function () {
                    gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
                    gl.bindTexture(gl.TEXTURE_2D, texture);
                    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
                    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
                    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);
                    gl.generateMipmap(gl.TEXTURE_2D);

                    gl.bindTexture(gl.TEXTURE_2D, null);
                }
                textureReflexion.image.src = texture_file;
            }

            function drawScene() {

                // Se configura el viewport dentro de area canvas. En este caso se utiliza toda 
                // el area disponible
                gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);

                // Se habilita el color de borrado para la pantalla (Color Buffer) y otros buffers
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

                // Se configura la matriz de proyeccion
                pMatrix = mat4.create();
                mat4.perspective(pMatrix, -30, gl.viewportWidth / gl.viewportHeight, 0.01, 100000.0);
                gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pMatrix);

                // Se configura la matriz de vista
                gl.uniformMatrix4fv(shaderProgram.ViewMatrixUniform, false, cameras.getMatrix());

                var cameraPosition = cameras.getPosition();
                gl.uniform3f(shaderProgram.cameraPosition, cameraPosition[0], cameraPosition[1], cameraPosition[2]); 

                /////////////////////////////////////////////////////
                // Configuracion de la luz
                // Se inicializan las variables asociadas con la Iluminacion
                gl.uniform3fv(shaderProgram.lightColor, lightColor);
                gl.uniform3fv(shaderProgram.lightPosition0, lightPosition0);
                gl.uniform3fv(shaderProgram.lightPosition1, lightPosition1);
                gl.uniform3fv(shaderProgram.lightPosition2, lightPosition2);

                gl.uniform1f(shaderProgram.utick, shader_utick);

                var reflexion = true;
                gl.uniform1i(shaderProgram.activeReflexion, reflexion);

                if (reflexion) {
                    gl.activeTexture(gl.TEXTURE0);
                    gl.bindTexture(gl.TEXTURE_2D, textureReflexion);
                    gl.uniform1i(shaderProgram.textureReflexion, 0);
                }

                var identity = mat4.create();
                mat4.identity(identity);
                all.draw(identity);

                gl.bindTexture(gl.TEXTURE_2D, null);
            }

            //	var lightPosition = [100.0,30.0,100.0];
            //	var ang_0 = -Math.PI/1.5;
            var rotSpeedDivider = 2;

            var lastUpdate = Date.now();
            var fps = 5;
            
            function tick() {
                requestAnimFrame(tick);
                
                var now = Date.now();
                if (now - lastUpdate <= 1000 / fps) {
                    return;
                }
                lastUpdate = Date.now();

                //bckShape.rotate(0,0.01/rotSpeedDivider,0);

                //lightPosition = [100.0*Math.cos(-shader_utick/rotSpeedDivider+ang_0),30.0,100.0*Math.sin(-shader_utick/rotSpeedDivider+ang_0)]

                shader_utick += 0.01;

                handleKeys();
                handleMouse();
                drawScene();
            }	


            var speed = 0.5;
            function handleKeys(event){ 		
                if( currentlyPressedKeys["|".charCodeAt(0)] ){
                    cameras.cycleCamera();
                }	
                if( currentlyPressedKeys["1".charCodeAt(0)] ){
                    cameras.ToCamera(0);
                }	
                if( currentlyPressedKeys["2".charCodeAt(0)] ){
                    cameras.ToCamera(1);
                }	
                if( currentlyPressedKeys["3".charCodeAt(0)] ){
                    cameras.ToCamera(2);
                }	
                if( currentlyPressedKeys["4".charCodeAt(0)] ){
                    cameras.ToCamera(3);
                }	


                if( currentlyPressedKeys["q".charCodeAt(0)] || currentlyPressedKeys["Q".charCodeAt(0)]){
                    cameras.Down(speed);
                }
                if( currentlyPressedKeys["e".charCodeAt(0)] || currentlyPressedKeys["E".charCodeAt(0)]){
                    cameras.Up(speed);
                }

                if( currentlyPressedKeys["s".charCodeAt(0)] || currentlyPressedKeys["S".charCodeAt(0)]){
                    cameras.Forward(speed);
                }
                if( currentlyPressedKeys["w".charCodeAt(0)] || currentlyPressedKeys["W".charCodeAt(0)]){
                    cameras.Backwards(speed);
                }

                if( currentlyPressedKeys["a".charCodeAt(0)] || currentlyPressedKeys["A".charCodeAt(0)]){
                    cameras.Left(speed);
                }		
                if( currentlyPressedKeys["d".charCodeAt(0)] || currentlyPressedKeys["D".charCodeAt(0)]){
                    cameras.Right(speed);
                }


                if( currentlyPressedKeys["i".charCodeAt(0)] || currentlyPressedKeys["I".charCodeAt(0)]){
                    crane.moveCrane(-speed);
                }	
                if( currentlyPressedKeys["k".charCodeAt(0)] || currentlyPressedKeys["K".charCodeAt(0)]){
                    crane.moveCrane(speed);
                }

                if( currentlyPressedKeys["j".charCodeAt(0)] || currentlyPressedKeys["J".charCodeAt(0)]){
                    crane.moveMover(-speed);
                }		
                if( currentlyPressedKeys["l".charCodeAt(0)] || currentlyPressedKeys["L".charCodeAt(0)]){
                    crane.moveMover(speed);
                }	

                if( currentlyPressedKeys["u".charCodeAt(0)] || currentlyPressedKeys["U".charCodeAt(0)]){
                    crane.moveCargo(speed);
                }				
                if( currentlyPressedKeys["o".charCodeAt(0)] || currentlyPressedKeys["O".charCodeAt(0)]){
                    crane.moveCargo(-speed);
                }		

                if( currentlyPressedKeys["9".charCodeAt(0)]){
                    crane.releaseCargo();
                }		
                if( currentlyPressedKeys["0".charCodeAt(0)] ){
                    crane.attachCargo();
                }			
            }

            function handleMouse(){
                if(locked){
                    cameras.Pitch(pitch);
                    cameras.Yaw(yaw);
                }
                pitch = 0;
                yaw = 0;
            }

            function myMoveFunction(event) {
                //console.log( "ev :" + event.clientX + " " +  event.clientY);
                //console.log( "mouse :" +mouseX + " " +  mouseY);

                if(locked){
                    var movementX = event.movementX || event.mozMovementX || event.webkitMovementX || 0;
                    var movementY = event.movementY || event.mozMovementY || event.webkitMovementY || 0;

                    if(movementX)
                        pitch = -movementX*rotAmount;

                    if(movementY)	
                        yaw = movementY*rotAmount;		
                    //console.log(movementX);
                }
                //console.log(locked);
            }

            function handleKeyDown(event){
                currentlyPressedKeys[event.keyCode] = true;
            }

            function handleKeyUp(event) {
                currentlyPressedKeys[event.keyCode] = false;
            }

            function pointerlockchange() {
                locked = !locked;
                //console.log(locked);
            }

            function lockPointer() {
                var lock = document.getElementById("pointer-lock-element");
                lock.requestPointerLock = lock.requestPointerLock    ||
                    lock.mozRequestPointerLock ||
                    lock.webkitRequestPointerLock;
                lock.requestPointerLock();
            }	

            function setUpListeners(){				
                document.addEventListener( 'mousemove', myMoveFunction, false );

                window.addEventListener('pointerlockchange', pointerlockchange, false);
                window.addEventListener('mozpointerlockchange', pointerlockchange, false);
                window.addEventListener('webkitpointerlockchange', pointerlockchange, false);
            }

            function webGLStart() {
                var canvas = document.getElementById("tp");
                initGL(canvas);
                initShaders();

                initTextureReflexion("./textures/reflexionMap.jpg");

                setUpListeners();		
                all = new ShapeGroup();

                //--------------------bck---------------------------
                //TODO: arreglar valores de todos los materiales
                var materialBck = {
                    ka: [0.1, 0.1, 0.1],
                    kd: [0.4, 0.4, 0.4],
                    ks: [0.4, 0.4, 0.4],
                    shininess: 2.0
                };
                bck = new Background(150, 150, materialBck);
                bck.initTexture("./textures/reflexionMap.jpg");	

                bckShape = new Shape(bck,objectUniform);
                bckShape.scale(800.0, 500.0, 800.0);
                bckShape.initBuffers();

                all.add(bckShape);
                //--------------------------------------------------

                //--------------------floor---------------------------
                var materialFloor = {
                    ka: [0.1, 0.1, 0.1],
                    kd: [0.4, 0.4, 0.4],
                    ks: [0.4, 0.4, 0.4],
                    shininess: 2.0
                };
                floor = new Box(20, 2.5, 40, materialFloor);
                floor.initTexture("./textures/floor.jpg");	

                floorShape = new Shape(floor,objectUniform);
                floorShape.translate(-8, -6.05 , 8);
                floorShape.initBuffers();

                all.add(floorShape);
                //--------------------------------------------------

                //--------------------pharos---------------------------
                var materialPharos = {
                    ka: [0.5, 0.5, 0.5],
                    kd: [0.1, 0.1, 0.1],
                    ks: [0.8, 0.8, 0.8],
                    shininess: 20.0
                };

                var heightPharo = 4.2;
                var radioPoste = 0.15;
                var radioPharo = 0.5;
                var delta = 32;

                pharos = new Pharos(objectUniform, heightPharo, radioPoste, radioPharo, delta, materialPharos);
                pharos.initTexture("./textures/gray.jpg", "./textures/dirtyWhite.jpg");

                pharosShape = new Shape(pharos, objectUniform);
                pharosShape.initBuffers();

                all.add(pharosShape);
                //--------------------------------------------------

                //--------------------lightCabin--------------------------
                var lightCabin = new TexturedSphere(32, 32, materialPharos);
                lightCabin.initTexture("./textures/dirtyWhite.jpg");	

                lightCabinShape = new Shape(lightCabin,objectUniform);
                lightCabinShape.initBuffers();

                lightCabinShape.scale(0.1, 0.1, 0.1);
                lightCabinShape.translate(lightPosition0[0],lightPosition0[1],lightPosition0[2]);

                all.add(lightCabinShape);		
                //--------------------------------------------------

                //--------------------water---------------------------
                var materialWater = {
                    ka: [0.2, 0.2, 0.2],
                    kd: [0.0, 0.0, 0.2],
                    ks: [0.4, 0.4, 0.4],
                    shininess: 2.0
                };
                water = new Plane(1600, 1600, 25, 25, true, materialWater);
                water.initTexture("./textures/water.jpg");	

                waterShape = new Shape(water,objectUniform);
                waterShape.translate(-800.0, -6 , 800.0);
                waterShape.rotate(-Math.PI/2, 0 , 0);	
                waterShape.initBuffers();

                all.add(waterShape);
                //--------------------------------------------------		

                //-----------------crane------------------------------
                var materialCrane = {
                    ka: [0.2, 0.2, 0.2],
                    kd: [0.2, 0.2, 0.2],
                    ks: [0.5, 0.5, 0.5],
                    shininess: 5.0
                };
                crane = new Crane(objectUniform,9, materialCrane);
                crane.initTexture("./textures/crane.jpg");
                crane.initTextureCargo("./textures/container_difusemap");
                crane.initTextureCabin("./textures/crane.jpg");
                crane.initTextureSupport("./textures/crane.jpg");
                crane.initTextureWheel("./textures/wheel.jpg","./textures/crane.jpg");
                crane.initBuffers();

                all.add(crane);
                //--------------------------------------------------

                //----------------------Island----------------------
                var materialIsland = {
                    ka: [0.2, 0.2, 0.2],
                    kd: [0.0, 0.2, 0.0],
                    ks: [0.4, 0.4, 0.4],
                    shininess: 2.0
                };
                island = new Island(objectUniform, materialIsland);
                island.initTexture("./textures/isla.jpg");
                island.initBuffers();

                all.add(island);		
                //--------------------------------------------------

                //--------------------ship--------------------------
                var materialShip = {
                    ka: [0.1, 0.1, 0.1],
                    kd: [0.3, 0.3, 0.3],
                    ks: [0.2, 0.2, 0.2],
                    shininess: 2.0
                };
                ship = new Ship(objectUniform, materialShip);
                ship.initTexture("./textures/bridgeBase.jpg");
                ship.initTextureTop("./textures/gray.jpg");
                ship.initBuffers();

                all.add(ship);
                //--------------------------------------------------

                ship.translate(8,-10,10);
                ship.scale(3,6,6);
                crane.translate(0, -1 , 10);

                island.translate(-5,20,-53);
                island.scale(10,6,7);	
                island.rotate(0.0,Math.PI/8,0.0);	

                document.onkeydown = handleKeyDown;
                document.onkeyup = handleKeyUp;

                //--------------------cameras-----------------------

                cameras = new CameraManager();
                cameras.add(new FreeCamera([0, 0, 30],[0,0,1],[0,1,0]));
                cameras.add(new WalkingCamera([0, -2.5, 25],[0,0,1],[0,1,0]));
                cameras.add(new OrbitalCamera([0, 0, 30],[0,0,10],[0,1,0]));

                var cabinCamera = new FirstPersonCamera([0, 0, 0],[0.2,-1,0],[0,1,0]);
                crane.setCabinCamera(cabinCamera);
                cameras.add(cabinCamera);
                //-------------------------------------------------

                gl.clearColor(0.0, 0.0, 0.0, 1.0);
                gl.enable(gl.DEPTH_TEST);
                tick();
            }

        </script>


    </head>


    <body onload="webGLStart();">
        <center>
            <h1>Sistemas Gr&aacute;ficos - 66.71</h1>
            <h2>Trabajo Pr&aacute;ctico</h2>
            <canvas id="tp" style="border: none;" width="1280" height="720">
                Your browser does not support the HTML5 canvas element.
            </canvas>
            <button onclick="lockPointer();" style="width:100%" >Lock it!</button>
            <div id="pointer-lock-element"></div>
        </center>
        <br/>

    </body>

</html>
